SQLite
-------
CREATE TABLE "tblpins" ("id" INTEGER PRIMARY KEY  AUTOINCREMENT  NOT NULL  UNIQUE , "pins" TEXT NOT NULL  UNIQUE );
CREATE TABLE "tbldevices" ("id" INTEGER PRIMARY KEY  AUTOINCREMENT  NOT NULL  UNIQUE , "devices" TEXT NOT NULL  DEFAULT Empty);
CREATE TABLE "tblsurgeprotection" ("id" \INTEGER PRIMARY KEY  AUTOINCREMENT  NOT NULL , "protect_enabled" TEXT NOT NULL  DEFAULT Unprotected);


MySQL
-------
CREATE TABLE `tblpins` (`id` int(2) NOT NULL AUTO_INCREMENT, `connectedrelayport` int(2), `pins` int(2) NOT NULL , PRIMARY 
KEY (`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8;
CREATE TABLE `tbldevices` (`id` int(2) NOT NULL AUTO_INCREMENT, `connectedrelayport` int(2), `devices` TEXT(50) NOT NULL, PRIMARY KEY (`id`)) 
ENGINE=InnoDB DEFAULT CHARSET=utf8;
CREATE TABLE `tblsurgeprotection` (`id` int(2) NOT NULL AUTO_INCREMENT, `connectedrelayport` int(2), `protect_enabled` TEXT(50) NOT NULL, PRIMARY KEY 
(`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8;
CREATE TABLE `tblrelaytransactions` (`id` int(2) NOT NULL AUTO_INCREMENT, `instanceid` text(50), `gpiopin` int(2) NOT NULL, `device` TEXT(50) NOT 
NULL, `switchmode` int(2) NOT NULL, `triggersource` TEXT(10), `timestamp` DATETIME, PRIMARY KEY (`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8;
CREATE TABLE `tblarchivedrelaytrans` (`id` int(20) NOT NULL AUTO_INCREMENT, `instanceid` tinytext, `gpiopin` int(2) NOT NULL,  `device` tinytext NOT NULL,
  `switchmode` int(2) NOT NULL, `triggersource` tinytext, `timestamp` datetime DEFAULT NULL,  PRIMARY KEY (`id`)) ENGINE=InnoDB DEFAULT CHARSET=utf8;
CREATE TABLE `tbldevicewattage` (`id` int(2) NOT NULL AUTO_INCREMENT, `device` tinytext, `wattage` int(5) NOT NULL,  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;




INSERT INTO tblpins VALUES (1, 1, 17);
INSERT INTO tblpins VALUES (2, 2, 27); 
INSERT INTO tblpins VALUES (3, 3, 22);
INSERT INTO tblpins VALUES (4, 4, 5);
INSERT INTO tblpins VALUES (5, 5, 18);
INSERT INTO tblpins VALUES (6, 6, 23);
INSERT INTO tblpins VALUES (7, 7, 24);
INSERT INTO tblpins VALUES (8, 8, 25);
INSERT INTO tblpins VALUES (9, 9, 12);
INSERT INTO tblpins VALUES (10, 10, 13);
INSERT INTO tblpins VALUES (11, 11, 19);
INSERT INTO tblpins VALUES (12, 12, 26);



INSERT INTO tbldevices VALUES (1, 1,"Table Fan");
INSERT INTO tbldevices VALUES (2, 2,"Pedestal Fan");
INSERT INTO tbldevices VALUES (3, 3,"CFL");
INSERT INTO tbldevices VALUES (4, 4, "Cooler");
INSERT INTO tbldevices VALUES (5, 5, "Chanting Machine");
INSERT INTO tbldevices VALUES (6, 6, "Bulb Cluster");
INSERT INTO tbldevices VALUES (7, 7, "Incasedent Bulb");
INSERT INTO tbldevices VALUES (8, 8, "LED Lamp");
INSERT INTO tbldevices VALUES (9, 9, "Jot Diya");
INSERT INTO tbldevices VALUES (10, 10, "Motor");
INSERT INTO tbldevices VALUES (11, 11, "Ceiling Fan");
INSERT INTO tbldevices VALUES (12, 12, "Tube Light");


INSERT INTO tblsurgeprotection VALUES (1, 1, "Surge Protection - IC");
INSERT INTO tblsurgeprotection VALUES (2, 2, "Surge Protection - IC");
INSERT INTO tblsurgeprotection VALUES (3, 3, "Surge Protection - IC");
INSERT INTO tblsurgeprotection VALUES (4, 4, "Surge Protection - IC");
INSERT INTO tblsurgeprotection VALUES (5, 5, "Unprotected");
INSERT INTO tblsurgeprotection VALUES (6, 6, "Unprotected");
INSERT INTO tblsurgeprotection VALUES (7, 7, "Unprotected");
INSERT INTO tblsurgeprotection VALUES (8, 8, "Unprotected");
INSERT INTO tblsurgeprotection VALUES (9, 9, "Surge Protection - RC");
INSERT INTO tblsurgeprotection VALUES (10, 10, "Surge Protection - RC");
INSERT INTO tblsurgeprotection VALUES (11, 11, "Surge Protection - RC");
INSERT INTO tblsurgeprotection VALUES (12, 12, "Surge Protection - RC");

INSERT INTO tbldevicewattage (device) (SELECT devices FROM tbldevices ORDER BY devices ASC);
update tbldevicewattage set wattage = 15 where device = "Bulb Cluster";
update tbldevicewattage set wattage = 40 where device = "Ceiling Fan";
update tbldevicewattage set wattage = 15 where device = "CFL";
update tbldevicewattage set wattage = 30 where device = "Chanting Machine";
update tbldevicewattage set wattage = 60 where device = "Cooler";
update tbldevicewattage set wattage = 25 where device = "Incasedent Bulb";
update tbldevicewattage set wattage = 5 where device = "Jot Diya";
update tbldevicewattage set wattage = 8 where device = "LED Lamp";
update tbldevicewattage set wattage = 375 where device = "Motor";
update tbldevicewattage set wattage = 60 where device = "Pedestal Fan";
update tbldevicewattage set wattage = 45 where device = "Table Fan";
update tbldevicewattage set wattage = 40 where device = "Tube Light";




Aggregate Queries
-------------------


Report duration (seconds) GROUP BY device
------------------------------------------
SELECT a.gpiopin, a.device, sum(timestampdiff(second, a.timestamp, b.timestamp)) as duration from tblarchivedrelaytrans a INNER JOIN tblarchivedrelaytrans b on 
a.gpiopin = b.gpiopin AND a.switchmode = 1 and b.switchmode = 0 AND b.timestamp = (SELECT min(timestamp) from tblarchivedrelaytrans where gpiopin = a.gpiopin AND timestamp > a.timestamp) group by device ORDER BY duration DESC, device ASC;



Unique set of devices - For loop
------------------
select distinct device from tblrelaytransactions ORDER BY device ASC;

All transactions ordered by device
-------------------------------------
 select * from tblrelaytransactions where device IN (select distinct device from tblrelaytransactions GROUP BY device ) ORDER BY device ASC ;

Max and min Id Group BY Device
---------------------------------
select * from tblrelaytransactions WHERE switchmode = 1 GROUP BY device ORDER BY id DESC;

Show highest device used 
--------------------------
select device, count(device) from tblarchivedrelaytrans  group by device ORDER BY count(device) DESC;


Works for single max entires
-----------------------------
Select timestampdiff(minute, (select timestamp from tblrelaytransactions a where switchmode = 1 ORDER BY ID DESC LIMIT 1), (select timestamp from tblrelaytransactions b WHERE switchmode = 0 ORDER BY ID DESC LIMIT 1));



Stored Procedures
----------------------
----------------------

DROP PROCEDURE IF EXISTS sp_summarizedbill;
DELIMITER //
CREATE PROCEDURE sp_summarizedbill()
BEGIN
DROP TABLE IF EXISTS tmpcalcduration;
CREATE TABLE tmpcalcduration AS
SELECT a.gpiopin, a.device, SUM(TIMESTAMPDIFF(SECOND, a.timestamp, b.timestamp)) AS duration FROM tblarchivedrelaytrans a INNER JOIN   tblarchivedrelaytrans b 
on a.gpiopin = b.gpiopin AND a.switchmode = 1 and b.switchmode = 0 AND b.timestamp = (SELECT min(timestamp) FROM tblarchivedrelaytrans WHERE gpiopin = a.gpiopin 
AND timestamp > a.timestamp) GROUP BY device ORDER BY duration DESC, device ASC ;
SELECT a.gpiopin, a.device, a.duration, w.wattage, (a.duration*w.wattage*9)/(1000*3600) AS bill FROM tmptable a JOIN tbldevicewattage w on a.device = w.device;
DROP TABLE tmpcalcduration;
END //
DELIMITER ;


DROP PROCEDURE IF EXISTS sp_generatecompletebill;
DELIMITER //
CREATE PROCEDURE sp_generatecompletebill()
BEGIN
DROP TABLE IF EXISTS tmpcalcduration, tmpcalcbill;
CREATE TABLE tmpcalcduration AS
SELECT a.gpiopin, a.device, SUM(TIMESTAMPDIFF(SECOND, a.timestamp, b.timestamp)) AS duration FROM tblarchivedrelaytrans a INNER JOIN   tblarchivedrelaytrans b 
on a.gpiopin = b.gpiopin AND a.switchmode = 1 and b.switchmode = 0 AND b.timestamp = (SELECT min(timestamp) FROM tblarchivedrelaytrans WHERE gpiopin = a.gpiopin 
AND timestamp > a.timestamp) GROUP BY device ORDER BY duration DESC, device ASC ;
CREATE TABLE tmpcalcbill AS 
SELECT a.gpiopin, a.device, a.duration, w.wattage, (a.duration*w.wattage*9)/(1000*3600) AS bill FROM tmpcalcduration a JOIN tbldevicewattage w on a.device = 
w.device;
SELECT * FROM tmpcalcbill;
SELECT SUM(bill) AS Total from tmpcalcbill;
DROP TABLE tmpcalcduration, tmpcalcbill;
END //
DELIMITER ;



